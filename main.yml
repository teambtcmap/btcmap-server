---

- name: btcmap
  hosts:
    - btcmap
  tasks:
    - name: Install deps
      pacman:
        name:
          - bash-completion
          - jq
          - git
          - caddy
        state: present

    - name: Enable and start Caddy service
      systemd:
        name: caddy
        enabled: yes
        state: started

    - name: Create a directory for data.btcmap.org
      file:
        path: /srv/http/data.btcmap.org
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Install generate-legacy-nodes.sh
      copy:
        src: scripts/generate-legacy-nodes.sh
        dest: /usr/local/bin/generate-legacy-nodes
        owner: root
        group: root
        mode: '0755'

    - name: Install fetch-elements.sh
      template:
        src: scripts/fetch-elements.sh
        dest: /usr/local/bin/fetch-elements
        owner: root
        group: root
        mode: '0755'

    - name: Install fetch-elements service
      template:
        src: scripts/fetch-elements.service
        dest: /usr/lib/systemd/system/fetch-elements.service
        owner: root
        group: root
        mode: '0644'

    - name: Install fetch-elements timer
      copy:
        src: scripts/fetch-elements.timer
        dest: /usr/lib/systemd/system/fetch-elements.timer
        owner: root
        group: root
        mode: '0644'

    - name: Enable and start fetch-elements timer
      systemd:
        name: fetch-elements.timer
        enabled: yes
        state: started

    - name: Install report-legacy-nodes.sh
      copy:
        src: scripts/report-legacy-nodes.sh
        dest: /usr/local/bin/report-legacy-nodes
        owner: root
        group: root
        mode: '0755'

    - name: Install report-legacy-nodes service
      template:
        src: scripts/report-legacy-nodes.service
        dest: /usr/lib/systemd/system/report-legacy-nodes.service
        owner: root
        group: root
        mode: '0644'

    - name: Install report-legacy-nodes timer
      copy:
        src: scripts/report-legacy-nodes.timer
        dest: /usr/lib/systemd/system/report-legacy-nodes.timer
        owner: root
        group: root
        mode: '0644'

    - name: Enable report-legacy-nodes timer
      systemd:
        name: report-legacy-nodes.timer
        enabled: yes
        state: started