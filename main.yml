---

- name: btcmap
  hosts:
    - btcmap
  tasks:
    - name: Install deps
      pacman:
        name:
          - bash-completion
          - jq
          - git
          - caddy
        state: present

    - name: Enable and start Caddy service
      systemd:
        name: caddy
        enabled: yes
        state: started

    - name: Create a directory for data.btcmap.org
      file:
        path: /srv/http/data.btcmap.org
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Install generate-legacy-nodes.sh
      copy:
        src: scripts/generate-legacy-nodes.sh
        dest: /usr/local/bin/generate-legacy-nodes
        owner: root
        group: root
        mode: '0755'

    - name: Install generate-legacy-nodes service
      template:
        src: scripts/generate-legacy-nodes.service
        dest: /usr/lib/systemd/system/generate-legacy-nodes.service
        owner: root
        group: root
        mode: '0644'

    - name: Install generate-legacy-nodes timer
      copy:
        src: scripts/generate-legacy-nodes.timer
        dest: /usr/lib/systemd/system/generate-legacy-nodes.timer
        owner: root
        group: root
        mode: '0644'

    - name: Enable and start generate-legacy-nodes timer
      systemd:
        name: generate-legacy-nodes.timer
        enabled: yes
        state: started

    - name: Install sync-elements service
      template:
        src: scripts/sync-elements.service
        dest: /usr/lib/systemd/system/sync-elements.service
        owner: root
        group: root
        mode: '0644'

    - name: Install sync-elements timer
      copy:
        src: scripts/sync-elements.timer
        dest: /usr/lib/systemd/system/sync-elements.timer
        owner: root
        group: root
        mode: '0644'

    - name: Enable and start sync-elements timer
      systemd:
        name: sync-elements.timer
        enabled: yes
        state: started

    - name: Install report-legacy-nodes.sh
      copy:
        src: scripts/report-legacy-nodes.sh
        dest: /usr/local/bin/report-legacy-nodes
        owner: root
        group: root
        mode: '0755'

    - name: Install report-legacy-nodes service
      template:
        src: scripts/report-legacy-nodes.service
        dest: /usr/lib/systemd/system/report-legacy-nodes.service
        owner: root
        group: root
        mode: '0644'

    - name: Install report-legacy-nodes timer
      copy:
        src: scripts/report-legacy-nodes.timer
        dest: /usr/lib/systemd/system/report-legacy-nodes.timer
        owner: root
        group: root
        mode: '0644'

    - name: Enable and start report-legacy-nodes timer
      systemd:
        name: report-legacy-nodes.timer
        enabled: yes
        state: started